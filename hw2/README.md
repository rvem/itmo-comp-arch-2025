# Домашнее задание 2

## Дедлайн

4 января 23:59 (UTC + 3).

Целью этого домашнего задания является реализация простого однотактного процессора, который реализует
подмножество архитектуры RISC-V, с помощью Verilog.

## **DISCLAMER**

При реализации данного домашнего задания **запрещается** переименовывать порты модулей, сами модули
и названия файлов, в которых они лежат.

Разрешается изменение типов портов, например с `output [31:0] port` на `output reg [31:0] port`.

В данном домашнем задании нет никаких ограничений на использование фичей из Verilog'а.

## Структура процессора

Часть модулей, необходимых для реализации процессора уже реализована в файлах:
1) Память команд и данных, модуль [memory.v](./memory.v)
2) Регистровый файл, модуль [register_file.v](./register_file.v)
3) Модуль для одиночного 32-битного регистра PC в [d_flop.v](./d_flop.v)

Чтение из памяти и регистрового файла асинхронное, запись происходит по фронту сигнала синхронизации.

Обратите внимание, что память команд изначально заполняется двоичными данными из файла `instructions.dat` и является read-only.

Память данных и регистры изначально заполнены нулями.

Вашей задачей является реализация управляющего устройства и соединение всех остальных модулей
в работающий процессор.

Сам процессор необходимо реализовывать в модуле [riscv_cpu.v](./riscv_cpu.v). Для упрощения
процесса тестирования процессор взаимодействует с регистром PC, памятью команд и данных, а также регистровым
файлом через входные/выходные порты.

Пример использования этого процессора можно найти в файле [cpu_test.v](./cpu_test.v),
в этом файле также находится простейший тестовый сценарий, который выполняет заданное количество инструкций, а затем
выводит содержимое регистров и памяти данных.

Примеры двоичного кода для запуска можно найти в [programs_samples](./programs_samples/README.md).
Для запуска `cpu_test.v` необходимо скопировать двоичный код в [`instructions.dat`](./instructions.dat).

### Unit тесты

Для запуска тестов:
```
iverilog -g2012 -o unit_tests unit_tests.v
vvp unit_tests
```

Disclaimer: прохождение всех тестов не гарантирует полный балл.

## Часть 1. Реализация базовых инструкций.

В базовой части этого домашнего задания вам необходимо реализовать процессор, который реализует инструкции
`lw`, `sw`, `add`, `sub`, `and`, `or`, `slt`, `beq`.

Команды кодируются следующим образом:

| Команда | imm          | rs1   | funct3 | rd    | opcode  |
|---------|--------------|-------|--------|-------|---------|
| lw      | xxxxxxxxxxxx | xxxxx | 010    | xxxxx | 0000011 |

```
rd = mem[rs1 + imm]
```

| Команда | imm[11:5] | rs2   | rs1   | funct3 | imm[4:0] | opcode  |
|---------|-----------|-------|-------|--------|----------|---------|
| sw      | xxxxxxx   | xxxxx | xxxxx | 010    | xxxxx    | 0100011 |

```
mem[rs1 + imm] = rs2
```


| Команда | funct7  | rs2   | rs1   | funct3 | rd    | opcode  |
|---------|---------|-------|-------|--------|-------|---------|
| add     | 0000000 | xxxxx | xxxxx | 000    | xxxxx | 0110011 |
| sub     | 0100000 | xxxxx | xxxxx | 000    | xxxxx | 0110011 |
| and     | 0000000 | xxxxx | xxxxx | 111    | xxxxx | 0110011 |
| or      | 0000000 | xxxxx | xxxxx | 110    | xxxxx | 0110011 |
| slt     | 0000000 | xxxxx | xxxxx | 010    | xxxxx | 0110011 |

```
rd = rs1 `op` rs2
```

| Команда | imm[12],imm[10:5] | rs2   | rs1   | funct3 | imm[4:1],imm[11] | opcode  |
|---------|-------------------|-------|-------|--------|------------------|---------|
| beq     | xxxxxxx           | xxxxx | xxxxx | 000    | xxxxx            | 1100011 |

```
if (rs1 == rs2) PC += imm
```

Напонимание: биты нумеруются справа налево, т.е. самый правый бит является самым младшим битом команды.

Данная часть оценивается в 10 баллов (1.25 за каждую инструкцию).

## Часть 2. Реализация дополнительных инструкций I/B/U-типа

В данной части необходимо дополнительно реализовать инструкции `addi`, `bne`, `blt`, `lui`.

| Команда | imm          | rs1   | funct3 | rd    | opcode  |
|---------|--------------|-------|--------|-------|---------|
| addi    | xxxxxxxxxxxx | xxxxx | 000    | xxxxx | 0010011 |

```
rd = rs1 + imm
```

| Команда | imm[12],imm[10:5] | rs2   | rs1   | funct3 | imm[4:1],imm[11] | opcode  |
|---------|-------------------|-------|-------|--------|------------------|---------|
| bne     | xxxxxxx           | xxxxx | xxxxx | 001    | xxxxx            | 1100011 |

```
if (rs1 != rs2) PC += imm
```

| Команда | imm[12],imm[10:5] | rs2   | rs1   | funct3 | imm[4:1],imm[11] | opcode  |
|---------|-------------------|-------|-------|--------|------------------|---------|
| blt     | xxxxxxx           | xxxxx | xxxxx | 100    | xxxxx            | 1100011 |

```
if (rs1 < rs2) PC += imm
```

| Команда | imm                  | rd    | opcode  |
|---------|----------------------|-------|---------|
| lui     | xxxxxxxxxxxxxxxxxxxx | xxxxx | 0110111 |

```
rd = imm << 12
```

Данная часть оценивается в 6 баллов: `addi` и `lui` стоят 2 балла каждая, `bne` и `blt` - 1 балл каждая.

### Часть 3. Реализация `goto` инструкций.

В данной части необходимо дополнительно реализовать инструкции `jal` и `jalr`.

| Команда | imm[20],imm[10:1],imm[11],imm[19:12] | rd    | opcode  |
|---------|--------------------------------------|-------|---------|
| jal     | xxxxxxxxxxxxxxxxxxxx                 | xxxxx | 1101111 |

```
PC += imm
rd = PC + 4
```

| Команда | imm          | rs1   | funct3 | rd    | opcode  |
|---------|--------------|-------|--------|-------|---------|
| jalr    | xxxxxxxxxxxx | xxxxx | 000    | xxxxx | 1100111 |

```
PC = rs1 + imm
rd = PC + 4
```

Данная часть оценивается в 4 балла, по 2 балла за реализацию каждой инструкции.

## Формат сдачи

Файл с решением `riscv_cpu.v` необходимо прислать в [гугл форму](https://forms.gle/hfM9SGVY3VcssMdUA).
